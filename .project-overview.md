# EOD Insurance Supplement Analysis System - Project Overview

## 🎯 Project Summary
Interactive Insurance Supplement Analysis System for **Estimate on Demand (EOD)** - transforming document analysis from batch processing to real-time, transparent workflow where users watch analysis happen step-by-step and control every recommendation.

## 🏗️ Architecture & Technology Stack

### Core Technologies
- **Frontend**: Next.js 15 + React 19 + TypeScript 5.9 + Tailwind CSS 4.x
- **Backend**: Node.js API routes with Claude SDK integration  
- **Authentication**: Auth.js v5 (NextAuth) + Prisma + invite-only onboarding
- **Database**: PostgreSQL (via Railway) + Prisma ORM
- **Real-time**: WebSockets for live progress updates
- **Hosting**: Railway for simplified deployment

### AI/ML Integration
- **Document Processing**: Mistral OCR API + Claude SDK (hybrid extraction architecture)
- **Text Extraction**: Mistral OCR for page-by-page markdown extraction (~$0.02 per doc)
- **Field Analysis**: Claude Haiku/Sonnet for business rule processing (~$0.001 per analysis)
- **Vision Processing**: Claude Vision for complex layouts (fallback)

## 📁 Project Structure & Key Locations

```
EOD-08.25-user-centric/
├── .taskmaster/                     # Task Master AI project management
│   ├── tasks/tasks.json            # Main task database
│   ├── docs/prd.txt                # Product requirements document
│   └── config.json                 # AI model configuration
├── .claude/                        # Claude Code configuration
│   ├── commands/tm/                # Task Master slash commands
│   ├── agents/                     # Specialized agent definitions
│   ├── settings.local.json         # Local Claude settings
│   └── hooks.json                  # Development hooks
├── src/
│   ├── app/                        # Next.js app router pages
│   ├── components/
│   │   ├── ui/                     # Shadcn UI components
│   │   ├── upload/                 # File upload interface
│   │   ├── analysis/               # Business rule components
│   │   ├── document/               # Interactive document viewer
│   │   │   ├── split-pane/         # Claims panel + document viewer
│   │   │   ├── text-view/          # Formatted markdown display
│   │   │   ├── pdf-view/           # Raw PDF with highlights
│   │   │   └── evidence/           # Source highlighting system
│   │   └── reports/                # Report generation
│   ├── lib/
│   │   ├── claude/                 # Claude SDK integration
│   │   ├── mistral/                # Mistral OCR integration
│   │   ├── extraction/             # Hybrid extraction engines
│   │   ├── database/               # Database operations
│   │   ├── pdf/                    # PDF processing utilities
│   │   ├── coordinates/            # Text-to-PDF mapping
│   │   └── websockets/             # Real-time updates
│   └── types/                      # TypeScript definitions
├── sessions/                       # Development session logs (TO BE CREATED)
│   ├── index.md                    # Session tracking index
│   └── 2025-01-DD-topic.md         # Individual session files
├── examples/                       # Sample documents for testing
├── CLAUDE.md                       # Main project instructions
├── USER-AUTH-GUIDANCE.md           # Authentication setup guide
└── lib/rules/                      # Business rule implementations
```

## 🎯 Core Business Logic - Insurance Supplement Rules

### 1. Hip/Ridge Cap Quality Assessment
- **Purpose**: Ensure purpose-built ridge caps vs cut 3-tab shingles
- **Standard**: ASTM D3161/D7158 compliance required
- **Logic**: Check ridge cap line items for "cut from 3 tab" descriptions
- **Location**: `lib/rules/ridge-cap-analysis.ts`

### 2. Starter Strip Quality Verification  
- **Purpose**: Universal starter courses vs inadequate cut shingles
- **Coverage**: Must match eave length from roof report
- **Standard**: Factory adhesive strips required for wind resistance
- **Location**: `lib/rules/starter-strip-analysis.ts`

### 3. Drip Edge & Gutter Apron Coverage
- **Purpose**: Proper edge protection at rakes (drip edge) and eaves (gutter apron)  
- **Calculation**: Linear feet must match roof measurements
- **Priority**: Critical for water management compliance
- **Location**: `lib/rules/drip-edge-gutter-apron-analysis.ts`

### 4. Ice & Water Barrier Code Compliance
- **Purpose**: Code-compliant coverage calculation
- **Formula**: Eave coverage based on soffit depth + wall thickness + roof pitch
- **Code**: IRC R905.1.2 requirements
- **Location**: `lib/rules/ice-water-barrier-analysis.ts`

## 🎨 User Experience Architecture

### Split-Pane Document Review Interface
```
┌─ Claims Panel (Left 30%) ────┐ ┌─ Document Viewer (Right 70%) ─┐
│                              │ │                               │
│ ✓ Hip/Ridge Cap (Found)      │ │ [Formatted Text] [Raw PDF]    │
│   └─ 6 units, Standard       │ │                               │
│                              │ │ ┌─ Text View ─────────────┐   │
│ ⚠ Starter Strip (Missing)    │ │ │ ### Line Items          │   │
│   └─ Add recommendation      │ │ │ 3b. Hip/Ridge cap -     │   │ 
│                              │ │ │ **Standard profile**    │   │
│ ✓ Gutter Apron (Found)       │ │ │ composition shingles    │   │
│   └─ 171.42 LF, Aluminum     │ │ │ [HIGHLIGHTED]           │   │
│                              │ │ └─────────────────────────┘   │
│ ❌ Drip Edge (Not Found)      │ │                               │
│   └─ Needs supplement        │ │ ┌─ PDF View ──────────────┐   │
│                              │ │ │ [Raw PDF at exact       │   │
│ ❌ Ice & Water (Not Found)    │ │ │  same location with     │   │
│   └─ Calculate coverage      │ │ │  highlighting overlay]   │   │
└──────────────────────────────┘ └───────────────────────────────┘
```

### Interactive Flow
1. **Click claim item** → Auto-scroll to source text/PDF location
2. **View evidence** → See highlighted text with reasoning  
3. **Edit/Accept/Reject** → Modify extraction with full audit trail
4. **Quick confirmation** → Toggle between text and PDF views
5. **Generate supplement** → Create professional report with references

## 💾 Database Schema Overview

### Core Tables
- **jobs**: Main job tracking with status progression
- **documents**: File storage and processing status
- **document_pages**: OCR-extracted page text (markdown format)
  - Full-text search index for fast document search
  - Page dimensions and image metadata
- **extracted_fields**: Business rule field extractions
  - Links to source document_pages with text coordinates  
  - User edit history and confidence scores
- **text_coordinates**: Mapping between extracted text and PDF positions
  - Enables highlighting and visual evidence display
- **rule_analysis**: Business rule results and user decisions
  - Audit trail of accept/edit/reject actions

## 🔧 Development Tools & Workflow

### Task Master AI Integration
- **Task Database**: `.taskmaster/tasks/tasks.json`
- **Commands**: Extensive slash command library in `.claude/commands/tm/`
- **Workflow**: `task-master next` → implement → `task-master set-status`
- **Research**: Built-in Perplexity integration for technical guidance

### Key Development Commands
```bash
# Task Management
task-master next                    # Get next available task
task-master show <id>              # View task details
task-master set-status --id=<id> --status=done

# Analysis & Planning  
task-master analyze-complexity     # Analyze task complexity
task-master expand --id=<id>      # Break task into subtasks
task-master research "query"      # Research technical questions
```

### Claude Code Slash Commands
- `/tm next` - Get next task to work on
- `/tm show <id>` - View specific task details
- `/tm done <id>` - Mark task complete
- Many more in `.claude/commands/tm/`

## 🚀 Deployment & Environment

### Environment Variables Required
```bash
# AI Services
ANTHROPIC_API_KEY=xxx           # Claude for field analysis
MISTRAL_API_KEY=xxx            # Mistral OCR for text extraction

# Database & Infrastructure
DATABASE_URL=postgresql://...   # Railway PostgreSQL
AUTH_SECRET=xxx                # Auth.js secret
AUTH_TRUST_HOST=true

# Authentication
GOOGLE_CLIENT_ID=xxx
GOOGLE_CLIENT_SECRET=xxx

# Communication  
EMAIL_FROM=noreply@yourdomain.com
RESEND_API_KEY=xxx

# Real-time Updates
NEXT_PUBLIC_WS_URL=xxx
```

### Hosting Details
- **Platform**: Railway (https://railway.app)
- **Database**: PostgreSQL with automated backups
- **File Storage**: Railway volumes for uploaded documents
- **Domain**: Custom domain with SSL

## 🎯 Current Project Status

### Active Development Areas
1. **Drip Edge & Gutter Apron Analysis** - Recently implemented business rule logic
2. **Interactive Document Review UI** - Split-pane architecture with evidence highlighting
3. **Real-time Progress Updates** - WebSocket integration for live analysis feedback
4. **Professional Report Generation** - Client-ready supplement reports

### Recent Accomplishments
- Implemented Ridge Cap Analysis with auto-scroll and PDF highlighting
- Added Drip Edge & Gutter Apron business rule analysis  
- Created session documentation system
- Enhanced Task Master integration with specialized agents

### Key Files Recently Modified
- `lib/rules/drip-edge-gutter-apron-analysis.ts` - Core business logic
- `components/document/split-pane/` - Interactive document viewer
- `components/analysis/` - Business rule components
- `.taskmaster/tasks/tasks.json` - Active task management

## 🧠 Development Context & Patterns

### Code Conventions
- **TypeScript**: Strict mode with comprehensive type definitions
- **Components**: Functional components with hooks
- **Styling**: Tailwind CSS with consistent design tokens
- **Error Handling**: Comprehensive error boundaries and user-friendly messages
- **Testing**: Unit tests for business logic, E2E for user workflows

### AI Integration Patterns
- **Hybrid Extraction**: Mistral OCR → Claude Analysis pipeline
- **Structured Outputs**: JSON schemas for consistent field extraction
- **Confidence Scoring**: Track and display AI confidence levels
- **Human Override**: Full user control over AI recommendations
- **Audit Trails**: Complete history of user decisions and edits

### Performance Optimization
- **Lazy Loading**: Components and PDF processing
- **Caching**: Extracted data to avoid reprocessing
- **Chunking**: Large file processing with progress updates
- **Request Deduplication**: Avoid duplicate API calls

## 📚 Key Documentation Files

1. **CLAUDE.md** - Main development guidelines and project context
2. **USER-AUTH-GUIDANCE.md** - Complete authentication setup guide  
3. **.taskmaster/CLAUDE.md** - Task Master AI integration instructions
4. **lib/rules/README.md** - Business rule implementation documentation
5. **components/document/README.md** - Interactive document viewer architecture

## 🎯 Success Criteria

### User Experience Goals
- Upload to first insight in < 2 minutes
- 85%+ user acceptance of recommendations  
- Zero manual data entry for standard cases
- Professional output quality for client delivery

### Technical Performance Goals
- 99% uptime on Railway hosting
- < 3 second page load times
- Support 10+ concurrent users
- < 30 seconds per business rule analysis

---

**Client Context**: Estimate on Demand (EOD) specializes in insurance supplement analysis. They need professional output quality for client delivery, transparent reasoning for insurance adjuster review, flexibility to handle various document formats, and reliable performance for daily business operations.

**Development Philosophy**: Prioritize accuracy, transparency, and user control over automation shortcuts. This is a professional tool for expert users who need to understand and validate every AI decision.