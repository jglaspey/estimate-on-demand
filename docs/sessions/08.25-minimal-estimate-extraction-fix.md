# Session: Minimal Estimate Extraction Fix

**Date**: 2025-08-25
**Issue**: Tierney minimal estimate causing extraction failures and false positive drip edge detection

## Problem Analysis

### 1. Phase 1 Timeout Issue
- **Symptom**: Phase 1 extraction timing out after 30 seconds with 0 fields found
- **Root Cause**: Tierney estimate is extremely minimal - just summary pages with totals, no standard estimate format
- **Impact**: Customer name, address, carrier info all missing from UI

### 2. False Positive Drip Edge Detection
- **Symptom**: Drip edge showing as "present" when it doesn't exist in the estimate
- **Root Cause**: Multi-layered issue:
  1. V2 extraction finds only 1 line item (Hip/Ridge cap) from the minimal estimate
  2. Analysis fallback runs drip/gutter extractors on ALL pages including roof report
  3. Gutter apron extractor picks up "Eaves Flashing" from roof report (measurement label, not line item)
  4. "Eaves Flashing" is incorrectly treated as a gutter apron line item

## Fixes Applied

### 1. Increased Phase 1 Timeout
- Changed from 30 seconds to 45 seconds in:
  - `lib/extraction/claude-phase1-extractor.ts`
  - `lib/extraction/upload-integration.ts`
- Gives more time for minimal estimates to process

### 2. Improved Extractor Instructions
- **Drip Edge Extractor**: Added explicit instruction to extract ONLY line items from insurance estimates with prices, NOT measurement labels from roof reports
- **Gutter Apron Extractor**: Added explicit instruction to exclude measurement labels like "Eaves Flashing" from roof reports

### 3. Key Distinction
- **Line Items**: Have codes, descriptions, quantities, unit prices, totals (from estimates)
- **Measurement Labels**: Just descriptive text for measurements (from roof reports)

## Testing Recommendations

1. Re-run the Tierney jobs to verify:
   - Phase 1 completes without timeout
   - No false positive drip edge detection
   - Proper identification of missing business rule items

2. Test with other minimal estimates to ensure robustness

## Future Improvements

1. Consider separating estimate pages from roof report pages before extraction
2. Add validation to ensure extracted items have proper line item structure
3. Implement better handling for non-standard estimate formats
4. Consider adding a "minimal estimate" detection flag to adjust processing accordingly
